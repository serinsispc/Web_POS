@using System
@using System.Text
@using Newtonsoft.Json.Linq

@{
    ViewBag.Title = "Historial Ventas";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";

    // JSON base (solo para prellenar filtros)
    var rawJsonObj = Session["HistorialVentasJson"];
    var rawJson = rawJsonObj as string ?? "{}";

    // JSON de resoluciones (para modal)
    var rawResolObj = Session["V_Resoluciones"];
    var rawResol = rawResolObj as string ?? "[]";
    var resolBase64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(rawResol));

    // Parse de filtros para prellenar inputs
    JObject filtros = null;
    try { filtros = string.IsNullOrWhiteSpace(rawJson) ? null : JObject.Parse(rawJson); }
    catch { filtros = null; }

    string fecha1Input = filtros?["Fecha1"] != null
        ? DateTime.Parse(filtros["Fecha1"].ToString()).ToString("yyyy-MM-dd")
        : "";

    string fecha2Input = filtros?["Fecha2"] != null
        ? DateTime.Parse(filtros["Fecha2"].ToString()).ToString("yyyy-MM-dd")
        : "";

    string numeroInput = filtros?["NumeroFactura"]?.ToString() ?? "";
    string clienteInput = filtros?["NombreCliente"]?.ToString() ?? "";

    // --- CLIENTES (cuando se regresa de BotonEditar_AgregarCliente) ---
    var jsonClientes = (string)(Session["V_Clientes"] ?? "");
    var jsonClientesBase64 = string.IsNullOrEmpty(jsonClientes)
        ? ""
        : Convert.ToBase64String(Encoding.UTF8.GetBytes(jsonClientes));
    var debeMostrarModalClientes = !string.IsNullOrEmpty(jsonClientesBase64);

    // ===== Datos de la tabla (render servidor) =====
    var esCO = new System.Globalization.CultureInfo("es-CO");

    // Evita nulls y tipado
    var model = new WebCliente.ViewModels.HistorialVentasViewModels();
    if (rawJsonObj != null)
    {
        model = Newtonsoft.Json.JsonConvert.DeserializeObject<WebCliente.ViewModels.HistorialVentasViewModels>(rawJsonObj.ToString());
    }
    var listaventas = new List<RunApi.Models.Cliente.V_TablaVentas>();
    if (model.V_TablaVentas != null)
    {
        listaventas = model.V_TablaVentas;
    }
    // Totales/resumen en servidor
    int conteo = listaventas.Count;
    decimal totSubtotal = 0m, totImpuestos = 0m, totGeneral = 0m, totPropina = 0m;

    foreach (var v in listaventas)
    {
        totSubtotal += (decimal)(v.subtotalVenta ?? 0m);
        // Si tu objeto usa totalImpuestos / IVA / INC, ajusta aquí:
        var imp = (decimal)(v.IVA ?? 0m) + (decimal)(v.INC ?? 0m) + (decimal)(v.INCBolsas ?? 0m) + (decimal)(v.ivaVenta ?? 0m);
        totImpuestos += imp;
        totGeneral += (decimal)(v.totalVenta ?? 0m);
        totPropina += (decimal)(v.propina ?? 0m);
    }

    string resumenTexto = $"{conteo} ventas";
    string totalesTexto = $"Subtotal: {totSubtotal.ToString("C0", esCO)}  |  Impuestos: {totImpuestos.ToString("C0", esCO)}  |  Total: {totGeneral.ToString("C0", esCO)}";
    if (totPropina > 0) { totalesTexto += $"  |  Propina: {totPropina.ToString("C0", esCO)}"; }
}

<link href="~/Content/historialventas.css?v=1.9.0" rel="stylesheet" />

<div class="page-wrap historial-ventas" data-page="HistorialVentas">
    <!-- JSON base64 SOLO para Resoluciones -->
    <div id="hv-resol" data-json="@resolBase64"></div>

    <!-- === FORM oculto para Resolver (POST + AntiForgeryToken) -> ListaResoluciones === -->
    @using (Html.BeginForm("ListaResoluciones", "HistorialVentas", FormMethod.Post, new { id = "formResolucion", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inputIdVenta" value="" />
    }

    <!-- === FORM oculto para Seleccionar (POST + AntiForgeryToken) -> SeleccionarResoluciones === -->
    @using (Html.BeginForm("SeleccionarResoluciones", "HistorialVentas", FormMethod.Post, new { id = "formSelResol", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idResolucion" id="inp-idResolucion" value="0" />
    }

    <!-- === FORM oculto para abrir lista de clientes (rellena Session["V_Clientes"]) === -->
    @using (Html.BeginForm("BotonEditar_AgregarCliente", "HistorialVentas", FormMethod.Post, new { id = "formListaClientes", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inp-idventa-cliente" value="" />
    }

    @* formulario oculto para buscar nit en la DIAN *@
    @using (Html.BeginForm("BuscarNIT_DIAN", "HistorialVentas", FormMethod.Post, new { id = "formBuscarNIT_DIAN" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="nit" id="nit_dian_hidden" />
    }

    @* formulario oculto para enviar factura DIAN *@
    @using (Html.BeginForm("EnviarFacturaDIAN", "HistorialVentas", FormMethod.Post, new { id = "formEnviarDIAN", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inp-idventa-enviar" value="0" />
    }


    <!-- FILTROS -->
    <div class="card card-filter shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <!-- FORM 1: Fechas -->
                <div class="col-12 col-lg-6">
                    @using (Html.BeginForm("Filtar", "HistorialVentas", FormMethod.Post, new { id = "formFechas" }))
                    {
                        @Html.AntiForgeryToken()
                        <div class="row g-2">
                            <div class="col-12 col-lg-6">
                                <label class="form-label">Fecha desde</label>
                                <input type="date" id="fFechaDesde" name="fecha1" class="form-control" value="@fecha1Input" required />
                            </div>
                            <div class="col-12 col-lg-6">
                                <label class="form-label">Fecha hasta</label>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fFechaHasta" name="fecha2" class="form-control" value="@fecha2Input" required />
                                    <button id="btnFiltrarFechas" class="btn btn-outline-secondary" type="submit" title="Filtrar por rango de fechas">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- FORM 2: Número de Factura -->
                <div class="col-12 col-lg-3">
                    @using (Html.BeginForm("FiltarNumeroFactura", "HistorialVentas", FormMethod.Post, new { id = "formNumero" }))
                    {
                        @Html.AntiForgeryToken()
                        <label class="form-label">Número Factura</label>
                        <div class="input-group input-group-sm">
                            <input type="number" id="fNumeroFactura" name="numerofactura" class="form-control" placeholder="123…" value="@numeroInput" min="0" step="1" required />
                            <button id="btnBuscarNumero" class="btn btn-outline-secondary" type="submit" title="Buscar por número">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    }
                </div>

                <!-- FORM 3: Cliente -->
                <div class="col-12 col-lg-3">
                    @using (Html.BeginForm("FiltarNombreCliente", "HistorialVentas", FormMethod.Post, new { id = "formCliente" }))
                    {
                        @Html.AntiForgeryToken()
                        <label class="form-label">Filtrar Cliente</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="fClienteTexto" name="nombreCliente" class="form-control" placeholder="Nombre / NIT…" value="@clienteInput" required />
                            <button id="btnBuscarCliente" class="btn btn-outline-secondary" type="submit" title="Buscar cliente/NIT">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Acciones -->
            <div class="row mt-3 g-2 align-items-center">
                <div class="col-12 col-lg-8">
                    <!-- (Los switches cliente-side se removieron al no filtrar en JS) -->
                </div>

                <div class="col-12 col-lg-4">
                    <div class="d-flex gap-2 flex-wrap justify-content-lg-end">
                        <button id="btnExportar" class="btn btn-success btn-sm" type="button">
                            <i class="bi bi-filetype-csv me-1"></i> Exportar CSV
                        </button>
                        <button id="btnImprimir" class="btn btn-outline-primary btn-sm" type="button">
                            <i class="bi bi-printer me-1"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- CONTENIDO: tabla + panel lateral -->
    <div class="row">
        <div class="col-12 col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="tablaHV" class="table table-sm table-hover table-hv align-middle mb-0">
                            <thead>
                                <tr>
                                    <th data-col="numeroVenta">Número</th>
                                    <th data-col="fechaVenta">Fecha</th>
                                    <th data-col="tipoFactura">Tipo</th>
                                    <th class="text-end" data-col="total">Total</th>
                                    <th data-col="formaDePago">Forma de Pago</th>
                                    <th data-col="estadoVenta">Estado</th>
                                    <th data-col="nit">NIT</th>
                                    <th data-col="nombreCliente">Cliente</th>
                                    <th data-col="cufe">CUFE</th>
                                    @* la col "Más" ya no se agrega por JS (no hay overflow-mode) *@
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    foreach (var lista in listaventas)
                                    {
                                        // Estado CUFE según tipo de factura electrónica
                                        var cufeEstado = "--";
                                        if (lista.tipoFactura == "FACTURA ELECTRÓNICA DE VENTA")
                                        {
                                            if (lista.cufe == "--") { cufeEstado = "RECHAZADA"; }
                                            else { cufeEstado = "ACEPTADA"; }
                                        }

                                        // Atributos data-* para el JS (selección de fila)
                                        var dataIdVenta = lista.id;
                                        var dataTotal = (lista.totalVenta ?? 0m).ToString(System.Globalization.CultureInfo.InvariantCulture); // valor crudo
                                        var dataFechaIso = lista.fechaVenta.HasValue ? lista.fechaVenta.Value.ToString("s") : ""; // ISO 8601 "yyyy-MM-ddTHH:mm:ss"

                                        <tr data-idventa="@dataIdVenta"
                                            data-total="@dataTotal"
                                            data-fecha="@dataFechaIso"
                                            data-numero="@lista.numeroVenta">
                                            <td data-col="numeroVenta">@lista.prefijo @lista.numeroVenta</td>
                                            <td data-col="fechaVenta">@((lista.fechaVenta ?? DateTime.MinValue).ToString("yyyy-MM-dd HH:mm"))</td>
                                            <td data-col="tipoFactura">@lista.tipoFactura</td>
                                            <td class="text-end" data-col="total">@((lista.totalVenta ?? 0m).ToString("C0", esCO))</td>
                                            <td data-col="formaDePago">@lista.formaDePago</td>
                                            <td data-col="estadoVenta">@lista.estadoVenta</td>
                                            <td data-col="nit">@lista.nit</td>
                                            <td data-col="nombreCliente" title="@lista.nombreCliente">@lista.nombreCliente</td>
                                            <td data-col="cufe">@cufeEstado</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between flex-wrap gap-2">
                    <div id="resumenHV" class="small text-muted">@resumenTexto</div>
                    <div id="totalesHV" class="fw-semibold">@totalesTexto</div>
                </div>
            </div>
        </div>

        <!-- PANEL LATERAL -->
        <div class="col-12 col-lg-3 mt-3 mt-lg-0">
            <div class="hv-actions card shadow-sm">
                <div class="card-body p-3">
                    <div class="hv-section">
                        <div class="section-title">Acciones</div>
                        <div class="d-grid gap-2">
                            <button id="actImprimir" class="action-btn btn-light"><i class="bi bi-printer"></i> Imprimir</button>
                            <button id="actVerDetalle" class="action-btn btn-light"><i class="bi bi-eye"></i> Ver Detalle</button>
                            <button id="actAnular" class="action-btn btn-light action-danger"><i class="bi bi-slash-circle"></i> Anular</button>
                            <button id="actClonar" class="action-btn btn-light"><i class="bi bi-files"></i> Clonar Factura</button>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Factura Electrónica</div>
                        <div class="d-grid gap-2">
                            <button id="actCrearFE" class="action-btn btn-light"><i class="bi bi-file-earmark-plus"></i> Crear Factura Electrónica</button>
                            <button id="actEnviarDIAN" class="action-btn btn-light"><i class="bi bi-send"></i> Enviar Factura DIAN</button>
                            <button id="actEnviarCorreo" class="action-btn btn-light"><i class="bi bi-envelope"></i> Enviar Factura Correo</button>
                            <button id="actPosAElectronica" class="action-btn btn-light"><i class="bi bi-arrow-left-right"></i> POS a ELECTRÓNICA</button>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Cliente & Totales</div>
                        <div class="d-grid gap-2">
                            <button id="actEditarCliente" class="action-btn btn-light"><i class="bi bi-person"></i> Editar o Agregar Cliente</button>
                            <div class="card hv-total">
                                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                                    <div class="small text-muted">Total</div>
                                    <div id="lblTotalSeleccion" class="fw-bold">$ 0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Fecha Facturación</div>
                        <div class="hv-fecha card">
                            <div class="card-body py-2 px-3">
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fFechaFacturacion" class="form-control">
                                    <button id="actEditarFecha" class="btn btn-outline-secondary">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Otras</div>
                        <div class="d-grid gap-2">
                            <button id="actDevolucion" class="action-btn btn-light"><i class="bi bi-arrow-counterclockwise"></i> Devolución</button>
                            <button id="actResolucion" class="action-btn btn-light"><i class="bi bi-gear"></i> Resolución</button>
                            <button id="actAumentarNumero" class="action-btn btn-light"><i class="bi bi-plus-square"></i> Aumentar Número</button>
                            <button id="actDescargarFactura" class="action-btn btn-light"><i class="bi bi-download"></i> Descargar Factura</button>
                            <button id="actExportar" class="action-btn btn-light"><i class="bi bi-filetype-csv"></i> Exportar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /row -->
</div> <!-- /page-wrap -->
<!-- ========= MODAL: Resoluciones ========= -->
<div class="modal fade" id="modalResoluciones" tabindex="-1" aria-labelledby="modalResolucionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content modal-resoluciones">
            <div class="modal-header">
                <h5 class="modal-title" id="modalResolucionesLabel">Resoluciones disponibles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="mb-2 small text-muted">
                    Selecciona la resolución para la venta actual.
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="tabla-resoluciones">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Prefijo</th>
                                <th>N° Resolución</th>
                                <th>Habilitación</th>
                                <th>Vigencia</th>
                                <th>Rango</th>
                                <th>Consecutivo</th>
                                <th>Estado</th>
                                <th>Llave técnica</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody><!-- filas por JS --></tbody>
                    </table>
                </div>

                <div class="alert alert-warning d-none" id="alerta-sin-resoluciones">
                    No hay resoluciones para mostrar.
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Seleccionar cliente -->
<div class="modal fade" id="modalClientes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <!-- Barra de búsqueda (la que ya tienes) -->
                <div class="row g-2 align-items-center mb-3">
                    <div class="col-12 col-md">
                        <input id="cli-buscar" class="form-control" type="search"
                               placeholder="Buscar por NIT, nombre, comercio, teléfono o correo" />
                    </div>
                    <div class="col-12 col-md-auto">
                        <button id="cli-limpiar" type="button" class="btn btn-outline-secondary">Limpiar</button>
                    </div>

                    <!-- NUEVO: búsqueda por NIT + botón DIAN -->
                    <div class="col-12 col-md-auto ms-auto">
                        <div class="input-group">
                            <input id="cli-dian-nit"
                                   class="form-control"
                                   type="text"
                                   inputmode="numeric"
                                   pattern="[0-9]"
                                   maxlength="15"
                                   autocomplete="off"
                                   placeholder="NIT..." />
                            <button id="cli-dian-btn" type="button" class="btn btn-dian">
                                @*<img src="~/Archivos/IMG/DIAN.png" alt="" width="18" height="18" class="me-2" />*@
                                Consultar DIAN
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de clientes -->
                <div class="table-responsive">
                    <table id="tablaClientes" class="table table-sm table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 140px;">NIT</th>
                                <th>Nombre</th>
                                <th style="width: 160px;">Nombre Comercial</th>
                                <th style="width: 120px;">Teléfono</th>
                                <th style="width: 160px;">Dirección</th>
                                <th style="width: 220px;">Correo</th>
                                <th style="width: 160px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @* Rellena dinámicamente en tu vista (ejemplo) *@
                            @* Cada fila debe traer data-idcliente para poder editar *@
                            @*
                                @foreach (var c in Model.Clientes) {
                                  <tr data-idcliente="@c.Id"
                                      data-nit="@c.Nit"
                                      data-nombre="@c.Nombre"
                                      data-comercial="@c.NombreComercial"
                                      data-telefono="@c.Telefono"
                                      data-direccion="@c.Direccion"
                                      data-correo="@c.Correo">
                                    <td>@c.Nit</td>
                                    <td>@c.Nombre</td>
                                    <td>@c.NombreComercial</td>
                                    <td>@c.Telefono</td>
                                    <td>@c.Direccion</td>
                                    <td>@c.Correo</td>
                                    <td class="text-nowrap">
                                      <button type="button" class="btn btn-primary btn-sm cli-seleccionar">
                                        <i class="bi bi-check2-circle me-1"></i> Seleccionar
                                      </button>
                                      <button type="button" class="btn btn-warning btn-sm cli-editar">
                                        <i class="bi bi-pencil-square me-1"></i> Editar
                                      </button>
                                    </td>
                                  </tr>
                                }
                            *@
                        </tbody>
                    </table>
                </div>

                <!-- NUEVO: Panel de edición (colapsable) -->
                <div id="cli-editor" class="card mt-3 d-none">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="m-0">Editar cliente</h6>
                            <button type="button" id="cli-editor-cerrar" class="btn btn-sm btn-outline-secondary">
                                Cerrar
                            </button>
                        </div>

                        <form id="cli-form">
                            <input type="hidden" id="cli-id" />
                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label class="form-label">NIT</label>
                                    <input id="cli-nit" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label">Nombre</label>
                                    <input id="cli-nombre" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Nombre Comercial</label>
                                    <input id="cli-comercial" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Teléfono</label>
                                    <input id="cli-telefono" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label">Dirección</label>
                                    <input id="cli-direccion" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label">Correo</label>
                                    <input id="cli-correo" class="form-control" type="email" />
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="button" id="cli-guardar" class="btn btn-success">
                                    <i class="bi bi-save2 me-1"></i> Guardar
                                </button>
                                <button type="button" id="cli-guardar-y-seleccionar" class="btn btn-success">
                                    <i class="bi bi-check2 me-1"></i> Guardar y seleccionar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>






<form id="formAcquirer" class="d-none" data-acq-form>
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <label class="form-label">NIT</label>
            <input type="text" class="form-control" id="acqNit" data-acq-field="Nit">
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Nombre / Razón social</label>
            <input type="text" class="form-control" id="acqName" data-acq-field="Name">
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Nombre comercial</label>
            <input type="text" class="form-control" id="acqCommercial" data-acq-field="NombreComercial">
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Correo</label>
            <input type="email" class="form-control" id="acqEmail" data-acq-field="Email">
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Teléfono</label>
            <input type="text" class="form-control" id="acqPhone" data-acq-field="Telefono">
        </div>
        <div class="col-12">
            <label class="form-label">Dirección</label>
            <input type="text" class="form-control" id="acqAddress" data-acq-field="Direccion">
        </div>
    </div>
</form>










<script>
    window.ClientesBase64 = "@jsonClientesBase64";
    window.DebeMostrarModalClientes = @(debeMostrarModalClientes ? "true" : "false");
</script>



<!-- jQuery (requerido por DataTables) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- DataTables + Bootstrap 5 + Responsive -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- Inicialización específica para #tablaHV -->
<script src="~/Scripts/hv.datatables.js?v=1.0.0"></script>


@if (TempData["AcquirerB64"] != null || TempData["AcquirerMsg"] != null)
{
    <script>
    window.DebeMostrarModalClientes = true;
    @* objeto base64 cuando encontró *@
    @if (TempData["AcquirerB64"] != null)
    {
      <text>window.AcquirerB64 = '@TempData["AcquirerB64"]';</text>
    }
    @* mensaje de no-encontrado *@
    @if (TempData["AcquirerMsg"] != null)
    {
      <text>window.AcquirerMsg = '@(TempData["AcquirerMsg"]?.ToString()?.Replace("'", "\\'"))';</text>
    }
    </script>
}


@using System.Text
@{
    var rawAcquirer = (string)(Session["acquirer"] ?? "{}");
    var acquirerB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(rawAcquirer));
}
<!-- Portador de datos para el JS -->
<div id="acquirerData"
     data-acquirer-json-b64="@acquirerB64">
</div>

<!-- (Opcional) SweetAlert2 si no lo cargas en el _Layout -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



<script src="~/Scripts/historialventas.js?v=1.9.0"></script>
