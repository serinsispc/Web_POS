@using System
@using System.Text
@using Newtonsoft.Json.Linq

@{
    ViewBag.Title = "Historial Ventas";
    Layout = "~/Views/Shared/_LayoutMenu.cshtml";

    // JSON base (solo para prellenar filtros)
    var rawJsonObj = Session["HistorialVentasJson"];
    var rawJson = rawJsonObj as string ?? "{}";

    // JSON de resoluciones (para modal)
    var rawResolObj = Session["V_Resoluciones"];
    var rawResol = rawResolObj as string ?? "[]";
    var resolBase64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(rawResol));

    // Parse de filtros para prellenar inputs
    JObject filtros = null;
    try { filtros = string.IsNullOrWhiteSpace(rawJson) ? null : JObject.Parse(rawJson); }
    catch { filtros = null; }

    string fecha1Input = filtros?["Fecha1"] != null
        ? DateTime.Parse(filtros["Fecha1"].ToString()).ToString("yyyy-MM-dd")
        : "";

    string fecha2Input = filtros?["Fecha2"] != null
        ? DateTime.Parse(filtros["Fecha2"].ToString()).ToString("yyyy-MM-dd")
        : "";

    string numeroInput = filtros?["NumeroFactura"]?.ToString() ?? "";
    string clienteInput = filtros?["NombreCliente"]?.ToString() ?? "";

    // --- CLIENTES (cuando se regresa de BotonEditar_AgregarCliente) ---
    var jsonClientes = (string)(Session["V_Clientes"] ?? "");
    var jsonClientesBase64 = string.IsNullOrEmpty(jsonClientes)
        ? ""
        : Convert.ToBase64String(Encoding.UTF8.GetBytes(jsonClientes));
    var debeMostrarModalClientes = !string.IsNullOrEmpty(jsonClientesBase64);

    // ===== Datos de la tabla (render servidor) =====
    var esCO = new System.Globalization.CultureInfo("es-CO");

    // Evita nulls y tipado
    var model = new WebCliente.ViewModels.HistorialVentasViewModels();
    if (rawJsonObj != null)
    {
        model = Newtonsoft.Json.JsonConvert.DeserializeObject<WebCliente.ViewModels.HistorialVentasViewModels>(rawJsonObj.ToString());
    }
    var listaventas = new List<RunApi.Models.Cliente.V_TablaVentas>();
    if (model.V_TablaVentas != null)
    {
        listaventas = model.V_TablaVentas;
    }
    // Totales/resumen en servidor
    int conteo = listaventas.Count;
    decimal totSubtotal = 0m, totImpuestos = 0m, totGeneral = 0m, totPropina = 0m;

    foreach (var v in listaventas)
    {
        totSubtotal += (decimal)(v.subtotalVenta ?? 0m);
        var imp = (decimal)(v.IVA ?? 0m) + (decimal)(v.INC ?? 0m) + (decimal)(v.INCBolsas ?? 0m) + (decimal)(v.ivaVenta ?? 0m);
        totImpuestos += imp;
        totGeneral += (decimal)(v.totalVenta ?? 0m);
        totPropina += (decimal)(v.propina ?? 0m);
    }

    string resumenTexto = $"{conteo} ventas";
    string totalesTexto = $"Subtotal: {totSubtotal.ToString("C0", esCO)}  |  Impuestos: {totImpuestos.ToString("C0", esCO)}  |  Total: {totGeneral.ToString("C0", esCO)}";
    if (totPropina > 0) { totalesTexto += $"  |  Propina: {totPropina.ToString("C0", esCO)}"; }
}

<link href="~/Content/historialventas.css?v=1.9.0" rel="stylesheet" />

<div class="page-wrap historial-ventas" data-page="HistorialVentas">
    <!-- JSON base64 SOLO para Resoluciones -->
    <div id="hv-resol" data-json="@resolBase64"></div>

    <!-- Carrier de clientes (sin JS) -->
    <div id="hv-clientes"
         data-clientes-b64="@jsonClientesBase64"
         data-autoshow="@(debeMostrarModalClientes ? "true" : "false")">
    </div>

    @* Carrier para alert moderno (sin JS) *@
    @{
        var sessionString = Session["HistorialVentasJson"] as string ?? "{}";
        var viewmodels = Newtonsoft.Json.JsonConvert
            .DeserializeObject<WebCliente.ViewModels.HistorialVentasViewModels>(sessionString)
            ?? new WebCliente.ViewModels.HistorialVentasViewModels();

        var alertModerno = viewmodels.AlertModerno ?? new WebCliente.ViewModels.AlertModerno();

        string icono = (alertModerno.tipoAlert ?? "").Trim().ToLowerInvariant();
        switch (icono)
        {
            case "success":
            case "exito":
            case "ok":
                icono = "success"; break;
            case "error":
            case "danger":
            case "fail":
                icono = "error"; break;
            case "warning":
            case "warn":
            case "alerta":
                icono = "warning"; break;
            default:
                icono = "info"; break;
        }
    }
    <div id="hv-alert"
         data-show="@((alertModerno.mostrar ? "true" : "false"))"
         data-icon="@icono"
         data-title="@((alertModerno.titulo ?? "").Replace("\"","\\\""))"
         data-text="@((alertModerno.mensaje ?? "").Replace("\"","\\\""))">
    </div>

    <!-- === FORM oculto para Resolver (POST + AntiForgeryToken) -> ListaResoluciones === -->
    @using (Html.BeginForm("ListaResoluciones", "HistorialVentas", FormMethod.Post, new { id = "formResolucion", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inputIdVenta" value="" />
    }

    <!-- === FORM oculto para Seleccionar (POST + AntiForgeryToken) -> SeleccionarResoluciones === -->
    @using (Html.BeginForm("SeleccionarResoluciones", "HistorialVentas", FormMethod.Post, new { id = "formSelResol", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idResolucion" id="inp-idResolucion" value="0" />
    }

    <!-- === FORM oculto para abrir lista de clientes === -->
    @using (Html.BeginForm("BotonEditar_AgregarCliente", "HistorialVentas", FormMethod.Post, new { id = "formListaClientes", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inp-idventa-cliente" value="" />
    }

    @* formulario oculto para buscar nit en la DIAN *@
    @using (Html.BeginForm("BuscarNIT_DIAN", "HistorialVentas", FormMethod.Post, new { id = "formBuscarNIT_DIAN" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="nit" id="nit_dian_hidden" />
    }

    @* formulario oculto para enviar factura DIAN *@
    @using (Html.BeginForm("EnviarFacturaDIAN", "HistorialVentas", FormMethod.Post, new { id = "formEnviarDIAN", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inp-idventa-enviar" value="0" />
    }

    @* formulario oculto para SeleccionarCliente (POST real) *@
    @using (Html.BeginForm("SeleccionarCliente", "HistorialVentas", FormMethod.Post, new { id = "formSeleccionarCliente", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idCliente" id="idClienteSeleccionado" value="0" />
        <input type="hidden" name="idventa" id="inp-idventa-seleccion-cliente" value="0" />
    }

    @using (Html.BeginForm("MediosDePago", "HistorialVentas", FormMethod.Post, new { id = "formMediosDePago", @class = "d-none" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" id="inp-idventa-medios" name="idventa" value="" />
    }

    @using (Html.BeginForm("Retour", "HistorialVentas", FormMethod.Post, new { id = "formDescargarFactura", target = "_blank", @class = "d-none" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" name="idventa" id="inp-idventa-descargar" value="" />
    }

    <!-- FILTROS -->
    <div class="card card-filter shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <!-- FORM 1: Fechas -->
                <div class="col-12 col-lg-6">
                    @using (Html.BeginForm("Filtar", "HistorialVentas", FormMethod.Post, new { id = "formFechas" }))
                    {
                        @Html.AntiForgeryToken()
                        <div class="row g-2">
                            <div class="col-12 col-lg-6">
                                <label class="form-label">Fecha desde</label>
                                <input type="date" id="fFechaDesde" name="fecha1" class="form-control" value="@fecha1Input" required />
                            </div>
                            <div class="col-12 col-lg-6">
                                <label class="form-label">Fecha hasta</label>
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fFechaHasta" name="fecha2" class="form-control" value="@fecha2Input" required />
                                    <button id="btnFiltrarFechas" class="btn btn-outline-secondary" type="submit" title="Filtrar por rango de fechas">
                                        <i class="bi bi-funnel"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- FORM 2: Número de Factura -->
                <div class="col-12 col-lg-3">
                    @using (Html.BeginForm("FiltarNumeroFactura", "HistorialVentas", FormMethod.Post, new { id = "formNumero" }))
                    {
                        @Html.AntiForgeryToken()
                        <label class="form-label">Número Factura</label>
                        <div class="input-group input-group-sm">
                            <input type="number" id="fNumeroFactura" name="numerofactura" class="form-control" placeholder="123…" value="@numeroInput" min="0" step="1" required />
                            <button id="btnBuscarNumero" class="btn btn-outline-secondary" type="submit" title="Buscar por número">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    }
                </div>

                <!-- FORM 3: Cliente -->
                <div class="col-12 col-lg-3">
                    @using (Html.BeginForm("FiltarNombreCliente", "HistorialVentas", FormMethod.Post, new { id = "formCliente" }))
                    {
                        @Html.AntiForgeryToken()
                        <label class="form-label">Filtrar Cliente</label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="fClienteTexto" name="nombreCliente" class="form-control" placeholder="Nombre / NIT…" value="@clienteInput" required />
                            <button id="btnBuscarCliente" class="btn btn-outline-secondary" type="submit" title="Buscar cliente/NIT">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>

            @using (Html.BeginForm("ExportarExcelFiltro", "HistorialVentas", FormMethod.Post, new { id = "formExportarServidor" }))
            {
                @Html.AntiForgeryToken()
                <button type="submit"
                        id="btnExportarServidor"
                        class="btn btn-outline-primary mt-3"
                        onclick="event.stopPropagation();">
                    <i class="bi bi-filetype-csv"></i> Exportar (servidor)
                </button>
            }
        </div>
    </div>

    <!-- CONTENIDO: tabla + panel lateral -->
    <div class="row">
        <div class="col-12 col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="tablaHV" class="table table-sm table-hover table-hv align-middle mb-0">
                            <thead>
                                <tr>
                                    <th data-col="numeroVenta">Número</th>
                                    <th data-col="fechaVenta">Fecha</th>
                                    <th data-col="tipoFactura">Tipo</th>
                                    <th class="text-end" data-col="total">Total</th>
                                    <th data-col="formaDePago">Forma de Pago</th>
                                    <th data-col="medioDePago">Medio de Pago</th>
                                    <th data-col="estadoVenta">Estado</th>
                                    <th data-col="nit">NIT</th>
                                    <th data-col="nombreCliente">Cliente</th>
                                    <th data-col="estadoFE" class="all" data-priority="4">Estado FE</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    foreach (var lista in listaventas)
                                    {
                                        var esFacturaElectronica = (lista.tipoFactura ?? "").Trim().ToUpper() == "FACTURA ELECTRÓNICA DE VENTA";
                                        var cufeTexto = (lista.cufe ?? "").Trim();
                                        var hayCufe = !string.IsNullOrEmpty(cufeTexto) && cufeTexto != "--";

                                        var dataIdVenta = lista.id;
                                        var dataTotal = (lista.totalVenta ?? 0m).ToString(System.Globalization.CultureInfo.InvariantCulture);
                                        var dataFechaIso = lista.fechaVenta.HasValue ? lista.fechaVenta.Value.ToString("s") : "";

                                        <tr data-idventa="@dataIdVenta"
                                            data-total="@dataTotal"
                                            data-fecha="@dataFechaIso"
                                            data-numero="@lista.numeroVenta"
                                            data-prefijo="@lista.prefijo">
                                            <td data-col="numeroVenta">@lista.prefijo @lista.numeroVenta</td>
                                            <td data-col="fechaVenta">@((lista.fechaVenta ?? DateTime.MinValue).ToString("yyyy-MM-dd HH:mm"))</td>
                                            <td data-col="tipoFactura">@lista.tipoFactura</td>
                                            <td class="text-end" data-col="total">@((lista.totalVenta ?? 0m).ToString("C0", esCO))</td>
                                            <td data-col="formaDePago">@lista.formaDePago</td>
                                            <td data-col="medioDePago">@lista.medioDePago</td>
                                            <td data-col="estadoVenta">@lista.estadoVenta</td>
                                            <td data-col="nit">@lista.nit</td>
                                            <td data-col="nombreCliente" title="@lista.nombreCliente">@lista.nombreCliente</td>
                                            <td data-col="estadoFE">@lista.estadoFE</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between flex-wrap gap-2">
                    <div id="resumenHV" class="small text-muted">@resumenTexto</div>
                    <div id="totalesHV" class="fw-semibold">@totalesTexto</div>
                </div>
            </div>
        </div>

        <!-- PANEL LATERAL -->
        <div class="col-12 col-lg-3 mt-3 mt-lg-0">
            <div class="hv-actions card shadow-sm">
                <div class="card-body p-3">
                    <div class="hv-section">
                        <div class="section-title">Acciones</div>
                        <div class="d-grid gap-2">
                            <button type="button" id="actDescargarFactura" class="action-btn btn-light"><i class="bi bi-download"></i> Descargar Factura</button>
                            <button type="button" id="actImprimir" class="action-btn btn-light"><i class="bi bi-printer"></i> Imprimir</button>
                            <button type="button" id="actVerDetalle" class="action-btn btn-light"><i class="bi bi-eye"></i> Ver Detalle</button>

                            @using (Html.BeginForm("Anularfactura", "HistorialVentas", FormMethod.Post, new { id = "formAnular", @class = "d-inline" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="idventa" id="idventa_anular" value="" />
                                <button type="button" id="actAnular" class="action-btn btn-light action-danger">
                                    <i class="bi bi-slash-circle"></i> Anular
                                </button>
                            }

                            <button type="button" id="actClonar" class="action-btn btn-light"><i class="bi bi-files"></i> Clonar Factura</button>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Factura Electrónica</div>
                        <div class="d-grid gap-2">
                            <button type="button" id="actEnviarDIAN" class="action-btn btn-light"><i class="bi bi-send"></i> Enviar Factura DIAN</button>
                            <button type="button" id="actEnviarCorreo" class="action-btn btn-light"><i class="bi bi-envelope"></i> Enviar Factura Correo</button>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Cliente & Totales</div>
                        <div class="d-grid gap-2">
                            <button type="button" id="actEditarCliente" class="action-btn btn-light"><i class="bi bi-person"></i> Editar o Agregar Cliente</button>
                            <div class="card hv-total">
                                <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                                    <div class="small text-muted">Total</div>
                                    <div id="lblTotalSeleccion" class="fw-bold">$ 0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Fecha Facturación</div>
                        <div class="hv-fecha card">
                            <div class="card-body py-2 px-3">
                                <div class="input-group input-group-sm">
                                    <input type="date" id="fFechaFacturacion" class="form-control">
                                    <button type="button" id="actEditarFecha" class="btn btn-outline-secondary">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="hv-section mt-3">
                        <div class="section-title">Otras</div>
                        <div class="d-grid gap-2">
                            <button type="button" id="actDevolucion" class="action-btn btn-light"><i class="bi bi-arrow-counterclockwise"></i> Devolución</button>
                            <button type="button" id="actResolucion" class="action-btn btn-light"><i class="bi bi-gear"></i> Resolución</button>
                            <button type="button" id="actMediosDePago" class="action-btn btn-light"><i class="bi bi-credit-card"></i> Medios De Pago</button>
                            <button type="button" id="actAumentarNumero" class="action-btn btn-light"><i class="bi bi-plus-square"></i> Aumentar Número</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- /row -->
</div> <!-- /page-wrap -->
<!-- ========= MODAL: Resoluciones ========= -->
<div class="modal fade" id="modalResoluciones" tabindex="-1" aria-labelledby="modalResolucionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content modal-resoluciones">
            <div class="modal-header">
                <h5 class="modal-title" id="modalResolucionesLabel">Resoluciones disponibles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2 small text-muted">
                    Selecciona la resolución para la venta actual.
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="tabla-resoluciones">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Prefijo</th>
                                <th>N° Resolución</th>
                                <th>Habilitación</th>
                                <th>Vigencia</th>
                                <th>Rango</th>
                                <th>Consecutivo</th>
                                <th>Estado</th>
                                <th>Llave técnica</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody><!-- filas por JS --></tbody>
                    </table>
                </div>
                <div class="alert alert-warning d-none" id="alerta-sin-resoluciones">
                    No hay resoluciones para mostrar.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ========= MODAL: Seleccionar cliente ========= -->
<div class="modal fade" id="modalClientes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Barra de búsqueda -->
                <div class="row g-2 align-items-center mb-3">
                    <div class="col-12 col-md">
                        <input id="cli-buscar" class="form-control" type="search"
                               placeholder="Buscar por NIT, nombre, comercio, teléfono o correo" />
                    </div>
                    <div class="col-12 col-md-auto">
                        <button id="cli-limpiar" type="button" class="btn btn-outline-secondary">Limpiar</button>
                    </div>

                    <!-- Búsqueda por NIT + DIAN -->
                    <div class="col-12 col-md-auto ms-auto">
                        <div class="input-group">
                            <input id="cli-dian-nit"
                                   class="form-control"
                                   type="text"
                                   inputmode="numeric"
                                   pattern="[0-9]"
                                   maxlength="15"
                                   autocomplete="off"
                                   placeholder="NIT..." />
                            <button id="cli-dian-btn" type="button" class="btn btn-dian">
                                Consultar DIAN
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de clientes -->
                <div class="table-responsive">
                    <table id="tablaClientes" class="table table-sm table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width: 140px;">NIT</th>
                                <th>Nombre</th>
                                <th style="width: 160px;">Nombre Comercial</th>
                                <th style="width: 120px;">Teléfono</th>
                                <th style="width: 160px;">Dirección</th>
                                <th style="width: 220px;">Correo</th>
                                <th style="width: 160px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Panel de edición -->
                <div id="cli-editor" class="card mt-3 d-none">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="m-0">Editar cliente</h6>
                            <button type="button" id="cli-editor-cerrar" class="btn btn-sm btn-outline-secondary">Cerrar</button>
                        </div>

                        <form id="cli-form">
                            <input type="hidden" id="cli-id" />
                            <div class="row g-3">
                                <div class="col-12 col-md-4">
                                    <label class="form-label">NIT</label>
                                    <input id="cli-nit" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label">Nombre</label>
                                    <input id="cli-nombre" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Nombre Comercial</label>
                                    <input id="cli-comercial" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label">Teléfono</label>
                                    <input id="cli-telefono" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-8">
                                    <label class="form-label">Dirección</label>
                                    <input id="cli-direccion" class="form-control" type="text" />
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label">Correo</label>
                                    <input id="cli-correo" class="form-control" type="email" />
                                </div>
                            </div>

                            <div class="d-flex gap-2 mt-3">
                                <button type="button" id="cli-guardar" class="btn btn-success">
                                    <i class="bi bi-save2 me-1"></i> Guardar
                                </button>
                                <button type="button" id="cli-guardar-y-seleccionar" class="btn btn-success">
                                    <i class="bi bi-check2 me-1"></i> Guardar y seleccionar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ========= MODAL: Medios de Pago ========= -->
<div class="modal fade" id="modalMediosPago" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Medios de pago <small class="text-muted">Venta <span id="mp-idventa"></span></small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width:30%">Medio DIAN</th>
                                <th style="width:30%">Medio interno</th>
                                <th style="width:20%">Valor</th>
                                <th style="width:20%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="mp-tbody"><!-- filas por JS --></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

@* modal detalle venta *@
<div class="modal fade" id="modalVerDetalle" tabindex="-1" aria-labelledby="mdDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="mdDetalleLabel" class="modal-title">
                    Detalle de la venta <span id="mdDet-idventa" class="text-muted"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div id="mdDet-loader" class="text-center py-4 d-none">
                    <div class="spinner-border" role="status"><span class="visually-hidden">Cargando…</span></div>
                </div>

                <div id="mdDet-error" class="alert alert-danger d-none"></div>

                <div id="mdDet-tablewrap" class="table-responsive d-none">
                    <table class="table table-sm align-middle" id="tablaDetalleVenta">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Presentación</th>
                                <th class="text-end">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Desc.</th>
                                <th class="text-end">Imp. %</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-end">Total</th>
                                <th>Obs.</th>
                            </tr>
                        </thead>
                        <tbody><!-- filas por JS --></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <div class="me-auto">
                    <span class="fw-semibold me-3">Subtotal: <span id="mdDet-subtotal" class="text-primary"></span></span>
                    <span class="fw-semibold me-3">Impuestos: <span id="mdDet-impuestos" class="text-primary"></span></span>
                    <span class="fw-bold">Total: <span id="mdDet-total" class="text-success"></span></span>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


@* Portadores de datos para el JS *@
@using System.Text
@{
    var rawAcquirer = (string)(Session["acquirer"] ?? "{}");
    var acquirerB64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(rawAcquirer));
}

@{
    var autoMp = (TempData["AutoOpenMediosPago"] as bool?) == true ? "true" : "false";
    var mpJson = Session["MediosDePago_json"] as string ?? "";                 // <-- lo que guardó el Action
    var mpB64 = string.IsNullOrEmpty(mpJson) ? "" : Convert.ToBase64String(Encoding.UTF8.GetBytes(mpJson));
    var idventaMP = (Session["idventaMedioPago"] ?? "").ToString();
}
<div id="hv-mp" data-auto="@autoMp" data-json-b64="@mpB64" data-idventa="@idventaMP"></div>



<div id="acquirerData" data-acquirer-json-b64="@acquirerB64"></div>
<div id="acquirerTemp"
     data-acquirer-b64="@(TempData["AcquirerB64"] ?? "")"
     data-acquirer-msg="@( (TempData["AcquirerMsg"]?.ToString() ?? "").Replace("'", "\\'") )">
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<!-- DataTables + Bootstrap 5 + Responsive -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- Inicialización específica para #tablaHV -->
<script src="~/Scripts/hv.datatables.js?v=1.0.8"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@*
    /Scripts/hv.core.js                    // utilidades, selección, helpers comunes
    /Scripts/hv.modals.js                  // abrir/cerrar modales con cleanup
    /Scripts/hv.btn.anular.js              // botón Anular
    /Scripts/hv.btn.mediospago.js          // botón Medios de Pago (AJAX + render + guardar)
    /Scripts/hv.btn.resolucion.js          // botón Resolución (y tabla)
    /Scripts/hv.btn.cliente.js             // botón Editar/Agregar Cliente + modal Clientes
    /Scripts/hv.btn.dian.js                // botón Enviar DIAN
    /Scripts/hv.btn.misc.js                // Descargar, Imprimir, Ver Detalle, Aumentar número, Clonar, etc.
    /Scripts/hv.init.js                    // orquestación al DOMContentLoaded
*@

<!-- Modular JS para Historial Ventas -->
<script src="~/Scripts/hv.core.js?v=1.0.0"></script>
<script src="~/Scripts/hv.modals.js?v=1.0.0"></script>

<script src="~/Scripts/hv.btn.anular.js?v=1.0.0"></script>
<script src="~/Scripts/hv.btn.mediospago.js"></script>
<script src="~/Scripts/hv.btn.resolucion.js?v=1.0.0"></script>
<script src="~/Scripts/hv.btn.cliente.js?v=1.0.0"></script>
<script src="~/Scripts/hv.btn.dian.js?v=1.0.0"></script>
<script src="~/Scripts/hv.btn.misc.js?v=1.0.0"></script>
<script src="~/Scripts/hv.btn.descargar.js?v=1.0.0"></script>
<script src="~/Scripts/hv.detalleventa.js"></script>

<script src="~/Scripts/hv.init.js?v=1.0.0"></script>
